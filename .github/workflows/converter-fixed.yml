name: Minimal Template Converter

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Create directories
        run: mkdir -p Surge Loon
      
      - name: Convert scripts with fixed templates
        run: |
          for file in QuantumultX/*.js; do
            filename=$(basename "$file" .js)
            echo "Converting $filename..."
            
            # Create Loon plugin with fixed template
            cat > "Loon/${filename}.plugin" << EOL
#!name = ${filename}🔐APP解锁
#!desc = 媒体制作 - 插件
#!author = 🅜ⓘ🅚ⓔ🅟ⓗ🅘ⓔ
#!icon = https://raw.githubusercontent.com/Mikephie/icons/main/icon/${filename}.png

[Script]
http-response ^https?://example.com/ script-path=https://raw.githubusercontent.com/Mikephie/Script/main/qx/${filename}.js, requires-body=true, timeout=60, tag=${filename}

[MITM]
hostname = example.com
EOL
            
            # Create Surge module with fixed template
            cat > "Surge/${filename}.sgmodule" << EOL
#!name = ${filename}🔐APP
#!desc = 媒体制作 - 模块
#!author = 🅜ⓘ🅚ⓔ🅟ⓗ🅘ⓔ
#!category=🔐APP

[Script]
${filename} = type=http-response, pattern=^https?://example.com/, script-path=https://raw.githubusercontent.com/Mikephie/Script/main/qx/${filename}.js, requires-body=true, max-size=-1, timeout=60

[MITM]
hostname = %APPEND% example.com
EOL
          done
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Surge/ Loon/
          git diff-index --quiet HEAD || git commit -m "Auto convert scripts"
          git remote set-url origin https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}
          git push
